<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NALA API Test Console</title>
  <base href="/repo_deploy/" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #0f1115; color: #e8e8e8; }
    header { padding: 16px 20px; background: #151924; border-bottom: 1px solid #2a2f3a; }
    header h1 { margin: 0; font-size: 18px; }
    main { display: grid; grid-template-columns: 360px 1fr; gap: 14px; padding: 14px; }
    .card { background: #151924; border: 1px solid #2a2f3a; border-radius: 10px; padding: 12px; }
    .card h2 { margin: 0 0 10px 0; font-size: 14px; color: #b9c0d0; text-transform: uppercase; letter-spacing: .06em; }
    label { display: block; font-size: 12px; color: #b9c0d0; margin-top: 10px; }
    input, select, textarea { width: 100%; box-sizing: border-box; border-radius: 8px; border: 1px solid #2a2f3a; background: #0f1115; color: #e8e8e8; padding: 8px 10px; }
    textarea { min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btnrow { display: grid; gap: 8px; margin-top: 10px; }
    button { border: 0; border-radius: 8px; padding: 10px 12px; background: #2a6df4; color: #fff; font-weight: 600; cursor: pointer; }
    button.secondary { background: #2a2f3a; }
    button.danger { background: #c83b3b; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .split { display: grid; grid-template-rows: auto auto 1fr; gap: 10px; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; background: #2a2f3a; color: #b9c0d0; }
    .pill.ok { background: rgba(46, 160, 67, .2); color: #9be9a8; border: 1px solid rgba(46, 160, 67, .35); }
    .pill.bad { background: rgba(248, 81, 73, .18); color: #ffb1aa; border: 1px solid rgba(248, 81, 73, .35); }
    pre { margin: 0; padding: 12px; border-radius: 10px; border: 1px solid #2a2f3a; background: #0b0d12; overflow: auto; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small { font-size: 12px; color: #b9c0d0; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  </style>
</head>
<body>

<header>
  <h1>NALA API Test Console <span id="state" class="pill">—</span></h1>
  <div class="small">Base: <span class="mono" id="base"></span></div>
</header>

<main>
  <!-- Left controls -->
  <section class="card">
    <h2>Connection</h2>
    <label>API base URL</label>
    <input id="apiBase" placeholder="https://nala-test.com" value="https://nala-test.com" />

    <h2 style="margin-top:14px;">Auth</h2>
    <label>Email</label>
    <input id="email" placeholder="email" />
    <label>Password</label>
    <input id="password" type="password" placeholder="password" />

    <div class="btnrow">
      <button id="btnLogin">POST /api/login.php</button>
      <button id="btnMe" class="secondary">GET /api/me.php</button>
      <button id="btnLogout" class="danger">POST /api/logout.php</button>
    </div>

    <h2 style="margin-top:14px;">Session / Curriculum</h2>
    <div class="btnrow">
      <button id="btnCurr" class="secondary">GET /api/getCurriculum.php</button>
    </div>

    <h2 style="margin-top:14px;">Lessons</h2>
    <label>lesson_no clicked</label>
    <input id="lessonNo" type="number" value="0" />
    <div class="btnrow">
      <button id="btnLesson" class="secondary">POST /api/lessonComplete.php</button>
    </div>

    <h2 style="margin-top:14px;">Quiz</h2>
    <div class="grid2">
      <div>
        <label>module_id</label>
        <input id="quizModule" value="M1" />
      </div>
      <div>
        <label>count</label>
        <input id="quizCount" type="number" value="20" />
      </div>
    </div>
    <div class="btnrow">
      <button id="btnGetQuiz" class="secondary">GET /api/getQuiz.php</button>
    </div>

    <label>quiz_session_id (from getQuiz)</label>
    <input id="quizSessionId" type="number" value="0" />

    <label>answers JSON (map question_id -> choice letter)</label>
    <textarea id="answers" class="mono">{}</textarea>

    <div class="btnrow">
      <button id="btnSubmitQuiz">POST /api/submitQuiz.php</button>
    </div>

    <h2 style="margin-top:14px;">Admin Test: setUser (admin only)</h2>
    <label>role</label>
    <input id="suRole" value="admin" />
    <div class="grid2">
      <div>
        <label>module</label>
        <input id="suModule" value="M1" />
      </div>
      <div>
        <label>lesson index</label>
        <input id="suLesson" type="number" value="0" />
      </div>
    </div>
    <div class="btnrow">
      <button id="btnSetUser" class="secondary">GET /api/setUser.php</button>
    </div>
  </section>

  <!-- Right output -->
  <section class="split">
    <div class="card">
      <h2>Request</h2>
      <pre id="req" class="mono">{}</pre>
    </div>
    <div class="card">
      <h2>Response</h2>
      <pre id="out" class="mono">{}</pre>
    </div>
    <div class="card">
      <h2>Notes</h2>
      <div class="small">
        <ul>
          <li>All requests use <span class="mono">credentials: "include"</span> for cookie sessions.</li>
          <li><span class="mono">getQuiz.php</span> requires <span class="mono">module_id</span>.</li>
          <li><span class="mono">submitQuiz.php</span> expects <span class="mono">{ quiz_session_id, module_id, answers }</span>.</li>
          <li><span class="mono">setUser.php</span> is admin-only and supports <span class="mono">role</span>, <span class="mono">module</span>, <span class="mono">lesson</span>.</li>
        </ul>
      </div>
    </div>
  </section>
</main>

<script>
function setState(kind, text) {
  const el = document.getElementById("state");
  el.classList.remove("ok","bad");
  if (kind) el.classList.add(kind);
  el.textContent = text || "—";
}
function show(obj, targetId) {
  document.getElementById(targetId).textContent = JSON.stringify(obj, null, 2);
}
function base() {
  const b = document.getElementById("apiBase").value.trim().replace(/\/$/, "");
  document.getElementById("base").textContent = b;
  return b;
}
async function apiFetch(path, opts) {
  const url = base() + path;
  opts = opts || {};
  opts.credentials = "include";
  show({ url, ...opts }, "req");
  const res = await fetch(url, opts);
  const text = await res.text();
  let json = null;
  try { json = JSON.parse(text); } catch(e) {}
  show(json || { raw: text }, "out");
  if (res.ok) setState("ok", "OK");
  else setState("bad", "HTTP " + res.status);
  return { res, json, text };
}

document.getElementById("btnLogin").onclick = async () => {
  const payload = { email: email.value, password: password.value };
  await apiFetch("/api/login.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
};

document.getElementById("btnMe").onclick = async () => {
  await apiFetch("/api/me.php", { method: "GET" });
};

document.getElementById("btnLogout").onclick = async () => {
  await apiFetch("/api/logout.php", { method: "POST" });
};

document.getElementById("btnCurr").onclick = async () => {
  await apiFetch("/api/getCurriculum.php", { method: "GET" });
};

document.getElementById("btnLesson").onclick = async () => {
  const payload = { lesson_no: Number(document.getElementById("lessonNo").value || 0) };
  await apiFetch("/api/lessonComplete.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
};

document.getElementById("btnGetQuiz").onclick = async () => {
  const moduleId = document.getElementById("quizModule").value.trim();
  const count = Number(document.getElementById("quizCount").value || 20);
  const qs = new URLSearchParams({ module_id: moduleId, count: String(count) });
  const { json } = await apiFetch("/api/getQuiz.php?" + qs.toString(), { method: "GET" });
  if (json && json.quiz && json.quiz.quiz_session_id) {
    document.getElementById("quizSessionId").value = json.quiz.quiz_session_id;
  }
  if (json && json.quiz && Array.isArray(json.quiz.questions)) {
    // Pre-fill answers map with blanks
    const map = {};
    json.quiz.questions.forEach(q => map[String(q.id)] = "");
    document.getElementById("answers").value = JSON.stringify(map, null, 2);
  }
};

document.getElementById("btnSubmitQuiz").onclick = async () => {
  let answersMap = {};
  try { answersMap = JSON.parse(document.getElementById("answers").value || "{}"); } catch(e) {}
  const payload = {
    quiz_session_id: Number(document.getElementById("quizSessionId").value || 0),
    module_id: document.getElementById("quizModule").value.trim(),
    answers: answersMap
  };
  await apiFetch("/api/submitQuiz.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
};

document.getElementById("btnSetUser").onclick = async () => {
  const qs = new URLSearchParams();
  const role = document.getElementById("suRole").value.trim();
  const module = document.getElementById("suModule").value.trim();
  const lesson = document.getElementById("suLesson").value;

  if (role) qs.set("role", role);
  if (module) qs.set("module", module);
  if (lesson !== "") qs.set("lesson", String(Number(lesson)));

  await apiFetch("/api/setUser.php?" + qs.toString(), { method: "GET" });
};

window.addEventListener("load", () => {
  setState(null, "Ready");
  base();
});
</script>

</body>
</html>
